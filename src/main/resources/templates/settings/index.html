<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
      layout:decorate="~{layouts/main}">
<head>
    <title>Settings - Spring MCP Server</title>
    <style>
        /* Beautiful Dark Theme Schedule Status Card */
        .schedule-status-card {
            background: linear-gradient(135deg, #1a1f2e 0%, #252d3d 100%);
            border-radius: 12px;
            border: 1px solid rgba(99, 179, 237, 0.2);
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3),
                        0 0 20px rgba(99, 179, 237, 0.1);
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .schedule-status-card:hover {
            border-color: rgba(99, 179, 237, 0.4);
            box-shadow: 0 12px 32px rgba(0, 0, 0, 0.4),
                        0 0 30px rgba(99, 179, 237, 0.15);
            transform: translateY(-2px);
        }

        .schedule-status-header {
            background: linear-gradient(90deg, rgba(99, 179, 237, 0.15) 0%, rgba(99, 179, 237, 0.05) 100%);
            padding: 1rem 1.25rem;
            border-bottom: 1px solid rgba(99, 179, 237, 0.2);
            font-weight: 600;
            font-size: 1rem;
            color: #63b3ed;
            letter-spacing: 0.5px;
        }

        .schedule-status-body {
            padding: 1.5rem;
        }

        .status-item {
            background: rgba(255, 255, 255, 0.03);
            border-radius: 8px;
            padding: 1rem;
            border: 1px solid rgba(255, 255, 255, 0.08);
            transition: all 0.2s ease;
            height: 100%;
        }

        .status-item:hover {
            background: rgba(255, 255, 255, 0.05);
            border-color: rgba(99, 179, 237, 0.3);
            transform: translateY(-1px);
        }

        .status-label {
            font-size: 0.75rem;
            font-weight: 500;
            color: #a0aec0;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
        }

        .status-value {
            font-size: 1rem;
            font-weight: 600;
            color: #e2e8f0;
            display: flex;
            align-items: center;
        }

        .badge-status {
            display: inline-flex;
            align-items: center;
            padding: 0.4rem 0.8rem;
            border-radius: 6px;
            font-size: 0.875rem;
            font-weight: 600;
            transition: all 0.2s ease;
        }

        .badge-status-active {
            background: linear-gradient(135deg, rgba(72, 187, 120, 0.2) 0%, rgba(72, 187, 120, 0.1) 100%);
            color: #68d391;
            border: 1px solid rgba(72, 187, 120, 0.3);
        }

        .badge-status-active:hover {
            background: linear-gradient(135deg, rgba(72, 187, 120, 0.3) 0%, rgba(72, 187, 120, 0.15) 100%);
            box-shadow: 0 0 15px rgba(72, 187, 120, 0.2);
        }

        .time-display {
            background: linear-gradient(135deg, rgba(99, 179, 237, 0.15) 0%, rgba(99, 179, 237, 0.05) 100%);
            color: #63b3ed;
            padding: 0.4rem 0.8rem;
            border-radius: 6px;
            font-family: 'SF Mono', 'Monaco', 'Cascadia Code', 'Courier New', monospace;
            font-size: 0.95rem;
            font-weight: 600;
            border: 1px solid rgba(99, 179, 237, 0.3);
            letter-spacing: 0.5px;
        }

        .text-primary-custom {
            color: #63b3ed;
            font-weight: 500;
        }

        .text-muted-custom {
            color: #718096;
            font-style: italic;
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            .schedule-status-body {
                padding: 1rem;
            }

            .status-item {
                padding: 0.75rem;
            }
        }
    </style>
</head>
<body>
<div layout:fragment="content">
    <h1 class="mb-4">
        <i class="bi bi-gear-fill text-spring-green"></i> Settings
    </h1>

    <!-- MCP Server Settings -->
    <div class="card border-0 shadow-sm mb-4">
        <div class="card-header bg-white border-bottom">
            <h5 class="mb-0">
                <i class="bi bi-server"></i> MCP Server Configuration
            </h5>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label class="form-label text-muted">Server Status</label>
                    <div>
                        <span class="badge bg-success">
                            <i class="bi bi-check-circle"></i> <span th:text="${mcpServerStatus}">Running</span>
                        </span>
                    </div>
                </div>
                <div class="col-md-6 mb-3">
                    <label class="form-label text-muted">Server Port</label>
                    <div>
                        <code th:text="${mcpServerPort}">8080</code>
                    </div>
                </div>
                <div class="col-md-6 mb-3">
                    <label class="form-label text-muted">Database Status</label>
                    <div>
                        <span class="badge bg-success">
                            <i class="bi bi-check-circle"></i> <span th:text="${databaseStatus}">Connected</span>
                        </span>
                    </div>
                </div>
                <div class="col-md-6 mb-3">
                    <label class="form-label text-muted">MCP Endpoint</label>
                    <div>
                        <code>/mcp/spring/sse</code>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Application Settings -->
    <div class="card border-0 shadow-sm mb-4">
        <div class="card-header bg-white border-bottom">
            <h5 class="mb-0">
                <i class="bi bi-sliders"></i> Application Settings
            </h5>
        </div>
        <div class="card-body">
            <!-- Success/Error Messages -->
            <div th:if="${success}" class="alert alert-success alert-dismissible fade show" role="alert">
                <i class="bi bi-check-circle"></i> <span th:text="${success}">Settings saved</span>
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
            <div th:if="${error}" class="alert alert-danger alert-dismissible fade show" role="alert">
                <i class="bi bi-exclamation-triangle"></i> <span th:text="${error}">Error occurred</span>
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>

            <!-- Enterprise Subscription Form -->
            <form th:action="@{/settings}" method="post" id="settingsForm">
                <div class="mb-4">
                    <h6 class="mb-3">
                        <i class="bi bi-building"></i> Support Subscription
                    </h6>
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox"
                               id="enterpriseSubscriptionEnabled"
                               name="enterpriseSubscriptionEnabled"
                               th:checked="${settings.enterpriseSubscriptionEnabled}"
                               onchange="document.getElementById('settingsForm').submit()">
                        <label class="form-check-label" for="enterpriseSubscriptionEnabled">
                            <strong>Enterprise Support Subscription Enabled</strong>
                        </label>
                    </div>
                    <small class="form-text text-muted d-block mt-2">
                        <i class="bi bi-info-circle"></i>
                        When enabled, version support status will be determined by Enterprise Support End dates.
                        When disabled, OSS Support End dates will be used instead.
                        <strong>Settings are saved automatically when you toggle.</strong>
                    </small>
                </div>

                <div class="mb-3">
                    <h6 class="mb-2">Current Status</h6>
                    <div>
                        <span th:if="${settings.enterpriseSubscriptionEnabled}" class="badge bg-success">
                            <i class="bi bi-building-check"></i> Enterprise Support Active
                        </span>
                        <span th:unless="${settings.enterpriseSubscriptionEnabled}" class="badge bg-primary">
                            <i class="bi bi-code-square"></i> OSS Support Only
                        </span>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Scheduler Configuration -->
    <div class="card border-0 shadow-sm mb-4">
        <div class="card-header bg-white border-bottom">
            <h5 class="mb-0">
                <i class="bi bi-clock-history text-primary"></i> Automatic Sync Scheduler
            </h5>
            <small class="text-muted">Configure automatic comprehensive synchronization schedule</small>
        </div>
        <div class="card-body">
            <form th:action="@{/settings/scheduler}" method="post" id="schedulerForm">
                <div class="row mb-4">
                    <!-- Enable/Disable Scheduling -->
                    <div class="col-md-12 mb-3">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox"
                                   id="syncEnabled"
                                   name="syncEnabled"
                                   th:checked="${schedulerSettings.syncEnabled}">
                            <label class="form-check-label" for="syncEnabled">
                                <strong>Enable Automatic Sync</strong>
                            </label>
                        </div>
                        <small class="form-text text-muted d-block mt-1">
                            <i class="bi bi-info-circle"></i>
                            When enabled, comprehensive sync runs automatically at the scheduled time daily.
                        </small>
                    </div>

                    <!-- Sync Time -->
                    <div class="col-md-6 mb-3">
                        <label class="form-label">
                            <i class="bi bi-clock"></i> Sync Time
                        </label>

                        <!-- Hidden input to store the final 24h format time -->
                        <input type="hidden" id="syncTime" name="syncTime" th:value="${schedulerSettings.syncTime}">

                        <!-- 24h Format Dropdowns -->
                        <div id="time24hContainer" class="d-flex gap-2">
                            <select class="form-select" id="hour24" style="width: 80px;">
                                <!-- Hours 0-23 -->
                            </select>
                            <span class="align-self-center">:</span>
                            <select class="form-select" id="minute24" style="width: 80px;">
                                <!-- Minutes 0-59 -->
                            </select>
                        </div>

                        <!-- 12h Format Dropdowns -->
                        <div id="time12hContainer" class="d-none d-flex gap-2">
                            <select class="form-select" id="hour12" style="width: 80px;">
                                <!-- Hours 1-12 -->
                            </select>
                            <span class="align-self-center">:</span>
                            <select class="form-select" id="minute12" style="width: 80px;">
                                <!-- Minutes 0-59 -->
                            </select>
                            <select class="form-select" id="ampm" style="width: 80px;">
                                <option value="AM">AM</option>
                                <option value="PM">PM</option>
                            </select>
                        </div>

                        <small class="form-text text-muted d-block mt-1">
                            Time when automatic sync will run daily
                        </small>
                    </div>

                    <!-- Time Format Toggle -->
                    <div class="col-md-6 mb-3">
                        <label class="form-label">
                            <i class="bi bi-toggle-on"></i> Time Display Format
                        </label>
                        <div class="btn-group w-100" role="group">
                            <input type="radio" class="btn-check" name="timeFormatToggle" id="format24h"
                                   value="24h" th:checked="${schedulerSettings.timeFormat == '24h'}"
                                   onchange="updateTimeFormat('24h')">
                            <label class="btn btn-outline-primary" for="format24h">24h</label>

                            <input type="radio" class="btn-check" name="timeFormatToggle" id="format12h"
                                   value="12h" th:checked="${schedulerSettings.timeFormat == '12h'}"
                                   onchange="updateTimeFormat('12h')">
                            <label class="btn btn-outline-primary" for="format12h">12h</label>
                        </div>
                        <small class="form-text text-muted d-block mt-1">
                            Display preference (updates immediately)
                        </small>
                    </div>
                </div>

                <!-- Current Schedule Status - Beautiful Dark Theme -->
                <div th:if="${schedulerSettings.syncEnabled}" class="schedule-status-card mb-3">
                    <div class="schedule-status-header">
                        <i class="bi bi-clock-history me-2"></i>
                        <span>Current Schedule Status</span>
                    </div>
                    <div class="schedule-status-body">
                        <div class="row g-3">
                            <div class="col-md-6 col-lg-3">
                                <div class="status-item">
                                    <div class="status-label">
                                        <i class="bi bi-power text-success me-1"></i>
                                        Status
                                    </div>
                                    <div class="status-value">
                                        <span class="badge-status badge-status-active">
                                            <i class="bi bi-check-circle-fill me-1"></i>
                                            Active
                                        </span>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6 col-lg-3">
                                <div class="status-item">
                                    <div class="status-label">
                                        <i class="bi bi-alarm text-info me-1"></i>
                                        Scheduled Time
                                    </div>
                                    <div class="status-value">
                                        <code class="time-display" id="displayTimeText" th:text="${displayTime}">03:00</code>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6 col-lg-3">
                                <div class="status-item">
                                    <div class="status-label">
                                        <i class="bi bi-clock-history text-warning me-1"></i>
                                        Last Run
                                    </div>
                                    <div class="status-value">
                                        <span th:if="${schedulerSettings.lastSyncRun}"
                                              th:text="${#temporals.format(schedulerSettings.lastSyncRun, 'MMM dd, HH:mm')}">
                                            Never
                                        </span>
                                        <span class="text-muted-custom" th:unless="${schedulerSettings.lastSyncRun}">
                                            Never
                                        </span>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6 col-lg-3">
                                <div class="status-item">
                                    <div class="status-label">
                                        <i class="bi bi-calendar-event text-primary me-1"></i>
                                        Next Run
                                    </div>
                                    <div class="status-value">
                                        <span class="text-primary-custom" th:if="${schedulerSettings.nextSyncRun}"
                                              th:text="${#temporals.format(schedulerSettings.nextSyncRun, 'MMM dd, HH:mm')}">
                                            Calculating...
                                        </span>
                                        <span class="text-muted-custom" th:unless="${schedulerSettings.nextSyncRun}">
                                            Not scheduled
                                        </span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Submit Button -->
                <div class="d-grid">
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-calendar-check"></i> Set New Schedule
                    </button>
                </div>
            </form>

            <div class="alert alert-info border-0 mt-3 mb-0">
                <i class="bi bi-info-circle-fill text-warning"></i>
                <strong>Note:</strong> The scheduler runs comprehensive sync which includes all 7 phases.
                Changes to schedule take effect immediately after clicking "Set New Schedule".
            </div>
        </div>
    </div>

    <!-- API Key Management -->
    <div class="card border-0 shadow-sm mb-4">
        <div class="card-header bg-white border-bottom">
            <h5 class="mb-0">
                <i class="bi bi-key-fill text-warning"></i> API Key Management
            </h5>
            <small class="text-muted">Manage API keys for MCP endpoint authentication</small>
        </div>
        <div class="card-body">
            <!-- Stats -->
            <div class="row mb-4">
                <div class="col-md-4">
                    <div class="stat-box bg-primary bg-opacity-10 p-3 rounded">
                        <div class="text-primary fw-bold">Total Keys</div>
                        <div class="h4 mb-0" th:text="${apiKeyStats.total}">0</div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="stat-box bg-success bg-opacity-10 p-3 rounded">
                        <div class="text-success fw-bold">Active Keys</div>
                        <div class="h4 mb-0" th:text="${apiKeyStats.active}">0</div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="stat-box bg-secondary bg-opacity-10 p-3 rounded">
                        <div class="text-secondary fw-bold">Inactive Keys</div>
                        <div class="h4 mb-0" th:text="${apiKeyStats.inactive}">0</div>
                    </div>
                </div>
            </div>

            <!-- Create New Key Button -->
            <div class="mb-3">
                <button type="button" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#createApiKeyModal">
                    <i class="bi bi-plus-circle"></i> Create New API Key
                </button>
            </div>

            <!-- API Keys Table -->
            <div th:if="${#lists.isEmpty(apiKeys)}" class="alert alert-info">
                <i class="bi bi-info-circle"></i> No API keys created yet. Create your first API key to access MCP endpoints.
            </div>

            <div th:unless="${#lists.isEmpty(apiKeys)}" class="table-responsive">
                <table class="table table-hover">
                    <thead>
                    <tr>
                        <th>Name</th>
                        <th>Created</th>
                        <th>Created By</th>
                        <th>Last Used</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr th:each="key : ${apiKeys}">
                        <td>
                            <strong th:text="${key.name}">API Key Name</strong>
                            <br/>
                            <small class="text-muted" th:if="${key.description}" th:text="${key.description}"></small>
                        </td>
                        <td>
                            <small th:text="${#temporals.format(key.createdAt, 'MMM dd, yyyy HH:mm')}">Jan 01, 2025 12:00</small>
                        </td>
                        <td>
                            <span class="badge bg-info" th:text="${key.createdBy}">admin</span>
                        </td>
                        <td>
                            <small th:if="${key.lastUsedAt}" th:text="${#temporals.format(key.lastUsedAt, 'MMM dd, yyyy HH:mm')}">Jan 01, 2025 12:00</small>
                            <small th:unless="${key.lastUsedAt}" class="text-muted fst-italic">Never</small>
                        </td>
                        <td>
                            <span th:if="${key.isActive}" class="badge bg-success">
                                <i class="bi bi-check-circle"></i> Active
                            </span>
                            <span th:unless="${key.isActive}" class="badge bg-secondary">
                                <i class="bi bi-x-circle"></i> Inactive
                            </span>
                        </td>
                        <td>
                            <div class="btn-group btn-group-sm">
                                <button th:if="${key.isActive}" type="button" class="btn btn-outline-warning"
                                        th:data-key-id="${key.id}"
                                        onclick="deactivateApiKey(this.getAttribute('data-key-id'))"
                                        title="Deactivate">
                                    <i class="bi bi-pause-circle"></i>
                                </button>
                                <button th:unless="${key.isActive}" type="button" class="btn btn-outline-success"
                                        th:data-key-id="${key.id}"
                                        onclick="activateApiKey(this.getAttribute('data-key-id'))"
                                        title="Activate">
                                    <i class="bi bi-play-circle"></i>
                                </button>
                                <button type="button" class="btn btn-outline-danger"
                                        th:data-key-id="${key.id}"
                                        th:data-key-name="${key.name}"
                                        onclick="deleteApiKey(this.getAttribute('data-key-id'), this.getAttribute('data-key-name'))"
                                        title="Delete">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                    </tbody>
                </table>
            </div>

            <div class="alert alert-warning mt-3 mb-0">
                <i class="bi bi-shield-exclamation"></i>
                <strong>Security Note:</strong> API keys are stored securely using hashing.
                The plain text key is shown only once during creation. Keep your API keys secure and rotate them regularly.
            </div>
        </div>
    </div>

    <!-- System Information -->
    <div class="card border-0 shadow-sm">
        <div class="card-header bg-white border-bottom">
            <h5 class="mb-0">
                <i class="bi bi-info-square"></i> System Information
            </h5>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label class="form-label text-muted">Application Version</label>
                    <div>
                        <code>1.0.0</code>
                    </div>
                </div>
                <div class="col-md-6 mb-3">
                    <label class="form-label text-muted">Spring Boot Version</label>
                    <div>
                        <code>3.5.7</code>
                    </div>
                </div>
                <div class="col-md-6 mb-3">
                    <label class="form-label text-muted">Java Version</label>
                    <div>
                        <code>25</code>
                    </div>
                </div>
                <div class="col-md-6 mb-3">
                    <label class="form-label text-muted">Database</label>
                    <div>
                        <code>PostgreSQL 18</code>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Create API Key Modal -->
    <div class="modal fade" id="createApiKeyModal" tabindex="-1" aria-labelledby="createApiKeyModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="createApiKeyModalLabel">
                        <i class="bi bi-key-fill text-warning"></i> Create New API Key
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="createApiKeyForm">
                        <div class="mb-3">
                            <label for="apiKeyName" class="form-label">
                                Name <span class="text-danger">*</span>
                            </label>
                            <input type="text" class="form-control" id="apiKeyName" name="name"
                                   placeholder="e.g., Production MCP Client" required minlength="3" maxlength="255">
                            <small class="form-text text-muted">Minimum 3 characters. Unique identifier for this key.</small>
                        </div>

                        <div class="mb-3">
                            <label for="apiKeyDescription" class="form-label">Description (Optional)</label>
                            <textarea class="form-control" id="apiKeyDescription" name="description"
                                      rows="2" placeholder="Purpose of this API key..."></textarea>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Generated Key (Preview)</label>
                            <div class="input-group">
                                <input type="text" class="form-control font-monospace" id="generatedKeyPreview"
                                       readonly placeholder="Click 'Generate Key' button">
                                <button class="btn btn-outline-secondary" type="button" id="generateKeyBtn">
                                    <i class="bi bi-arrow-clockwise"></i> Generate Key
                                </button>
                            </div>
                            <small class="form-text text-muted">
                                <i class="bi bi-info-circle"></i>
                                A secure random key will be generated. You can preview it here before creating.
                            </small>
                        </div>

                        <div class="alert alert-warning mb-0">
                            <i class="bi bi-exclamation-triangle"></i>
                            <strong>Important:</strong> The API key will be shown only once after creation. Make sure to copy and store it securely.
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-success" id="createApiKeyBtn">
                        <i class="bi bi-plus-circle"></i> Create API Key
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- API Key Created Modal (Show Key One Time) -->
    <div class="modal fade" id="apiKeyCreatedModal" tabindex="-1" aria-labelledby="apiKeyCreatedModalLabel" aria-hidden="true"
         data-bs-backdrop="static" data-bs-keyboard="false">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-success text-white">
                    <h5 class="modal-title" id="apiKeyCreatedModalLabel">
                        <i class="bi bi-check-circle"></i> API Key Created Successfully
                    </h5>
                </div>
                <div class="modal-body">
                    <div class="alert alert-danger">
                        <i class="bi bi-exclamation-triangle-fill"></i>
                        <strong>IMPORTANT:</strong> This is the only time you will see this key. Copy it now and store it securely!
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-bold">API Key Name:</label>
                        <div id="createdKeyName" class="text-primary"></div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-bold">Your API Key:</label>
                        <div class="input-group">
                            <input type="text" class="form-control font-monospace" id="createdKeyValue"
                                   readonly style="font-size: 0.9rem;">
                            <button class="btn btn-primary" type="button" id="copyKeyBtn">
                                <i class="bi bi-clipboard"></i> Copy
                            </button>
                        </div>
                    </div>

                    <div class="alert alert-info mb-0">
                        <strong>How to use:</strong>
                        <ul class="mb-0 mt-2">
                            <li>Add to <code>X-API-Key</code> header: <code>X-API-Key: your_key_here</code></li>
                            <li>Or use <code>Authorization</code> header: <code>Authorization: Bearer your_key_here</code></li>
                        </ul>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-success" data-bs-dismiss="modal" onclick="location.reload()">
                        <i class="bi bi-check-circle"></i> I've Copied the Key
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Deactivate API Key Confirmation Modal -->
    <div class="modal fade" id="deactivateApiKeyModal" tabindex="-1" aria-labelledby="deactivateApiKeyModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-warning">
                    <h5 class="modal-title" id="deactivateApiKeyModalLabel">
                        <i class="bi bi-pause-circle-fill"></i> Deactivate API Key
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-warning mb-3">
                        <i class="bi bi-exclamation-triangle-fill"></i>
                        <strong>Warning:</strong> This action will prevent the API key from being used for authentication.
                    </div>
                    <p class="mb-2">Are you sure you want to deactivate this API key?</p>
                    <p class="text-muted mb-0">
                        <small>You can reactivate it later if needed.</small>
                    </p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="bi bi-x-circle"></i> Cancel
                    </button>
                    <button type="button" class="btn btn-warning" id="confirmDeactivateBtn">
                        <i class="bi bi-pause-circle"></i> Deactivate Key
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Delete API Key Confirmation Modal -->
    <div class="modal fade" id="deleteApiKeyModal" tabindex="-1" aria-labelledby="deleteApiKeyModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title" id="deleteApiKeyModalLabel">
                        <i class="bi bi-trash-fill"></i> Delete API Key
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-danger mb-3">
                        <i class="bi bi-exclamation-triangle-fill"></i>
                        <strong>Danger!</strong> This action cannot be undone.
                    </div>
                    <p class="mb-2">Are you sure you want to <strong>permanently delete</strong> the API key:</p>
                    <div class="bg-dark p-3 rounded mb-3">
                        <code class="text-warning" id="deleteKeyNameDisplay"></code>
                    </div>
                    <p class="text-danger mb-0">
                        <i class="bi bi-shield-exclamation"></i>
                        <strong>All applications using this key will immediately lose access!</strong>
                    </p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="bi bi-x-circle"></i> Cancel
                    </button>
                    <button type="button" class="btn btn-danger" id="confirmDeleteBtn">
                        <i class="bi bi-trash"></i> Delete Permanently
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Page-specific JavaScript -->
    <script>
        // Get CSRF token
        function getCsrfToken() {
            const csrfInput = document.querySelector('input[name="_csrf"]');
            return csrfInput ? csrfInput.value : '';
        }

        // Initialize time dropdowns
        function initializeTimeDropdowns() {
            const syncTimeValue = document.getElementById('syncTime').value; // Format: "HH:mm"
            const [hours24, minutes] = syncTimeValue.split(':').map(Number);

            // Populate 24h hour dropdown (0-23)
            const hour24Select = document.getElementById('hour24');
            for (let i = 0; i < 24; i++) {
                const option = document.createElement('option');
                option.value = String(i).padStart(2, '0');
                option.textContent = String(i).padStart(2, '0');
                if (i === hours24) option.selected = true;
                hour24Select.appendChild(option);
            }

            // Populate 24h minute dropdown (0-59)
            const minute24Select = document.getElementById('minute24');
            for (let i = 0; i < 60; i++) {
                const option = document.createElement('option');
                option.value = String(i).padStart(2, '0');
                option.textContent = String(i).padStart(2, '0');
                if (i === minutes) option.selected = true;
                minute24Select.appendChild(option);
            }

            // Populate 12h hour dropdown (1-12)
            const hour12Select = document.getElementById('hour12');
            for (let i = 1; i <= 12; i++) {
                const option = document.createElement('option');
                option.value = String(i).padStart(2, '0');
                option.textContent = String(i).padStart(2, '0');
                hour12Select.appendChild(option);
            }

            // Populate 12h minute dropdown (0-59)
            const minute12Select = document.getElementById('minute12');
            for (let i = 0; i < 60; i++) {
                const option = document.createElement('option');
                option.value = String(i).padStart(2, '0');
                option.textContent = String(i).padStart(2, '0');
                minute12Select.appendChild(option);
            }

            // Convert 24h to 12h and set values
            const isPM = hours24 >= 12;
            const hours12 = hours24 === 0 ? 12 : (hours24 > 12 ? hours24 - 12 : hours24);
            hour12Select.value = String(hours12).padStart(2, '0');
            minute12Select.value = String(minutes).padStart(2, '0');
            document.getElementById('ampm').value = isPM ? 'PM' : 'AM';

            // Add change listeners
            [hour24Select, minute24Select, hour12Select, minute12Select, document.getElementById('ampm')].forEach(select => {
                select.addEventListener('change', updateHiddenTimeInput);
            });
        }

        // Update hidden syncTime input when dropdowns change
        function updateHiddenTimeInput() {
            const currentFormat = document.querySelector('input[name="timeFormatToggle"]:checked').value;
            let hours24, minutes;

            if (currentFormat === '24h') {
                hours24 = document.getElementById('hour24').value;
                minutes = document.getElementById('minute24').value;
            } else {
                const hours12 = parseInt(document.getElementById('hour12').value);
                const ampm = document.getElementById('ampm').value;
                minutes = document.getElementById('minute12').value;

                // Convert 12h to 24h
                if (ampm === 'AM') {
                    hours24 = hours12 === 12 ? '00' : String(hours12).padStart(2, '0');
                } else {
                    hours24 = hours12 === 12 ? '12' : String(hours12 + 12).padStart(2, '0');
                }
            }

            document.getElementById('syncTime').value = `${hours24}:${minutes}`;
        }

        // Toggle between 12h and 24h time pickers
        function toggleTimePickers(format) {
            const time24Container = document.getElementById('time24hContainer');
            const time12Container = document.getElementById('time12hContainer');

            if (format === '24h') {
                time24Container.classList.remove('d-none');
                time12Container.classList.add('d-none');
            } else {
                time24Container.classList.add('d-none');
                time12Container.classList.remove('d-none');
            }

            // Sync the values between pickers
            updateHiddenTimeInput();
        }

        // Update time format immediately (AJAX)
        async function updateTimeFormat(format) {
            try {
                const formData = new FormData();
                formData.append('timeFormat', format);

                const csrfToken = getCsrfToken();
                if (!csrfToken) {
                    console.error('CSRF token not found');
                    alert('Failed to update time format: Security token not found');
                    return;
                }
                formData.append('_csrf', csrfToken);

                console.log('Sending time format update request:', format);

                const response = await fetch('/settings/scheduler/time-format', {
                    method: 'POST',
                    body: formData
                });

                console.log('Response status:', response.status);

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                console.log('Response data:', data);

                if (data.success) {
                    // Update display time if element exists
                    const displayTimeElement = document.getElementById('displayTimeText');
                    if (displayTimeElement) {
                        displayTimeElement.textContent = data.displayTime;
                        console.log('Updated display time to:', data.displayTime);
                    } else {
                        console.warn('displayTimeText element not found - skipping display update');
                    }

                    // Toggle time pickers
                    toggleTimePickers(format);

                    console.log('Time format updated successfully to:', format);
                } else {
                    console.error('Server returned error:', data.error);
                    alert('Failed to update time format: ' + (data.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error updating time format:', error);
                alert('Failed to update time format: ' + error.message);
            }
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            initializeTimeDropdowns();

            // Set initial time picker visibility
            const currentFormat = document.querySelector('input[name="timeFormatToggle"]:checked').value;
            toggleTimePickers(currentFormat);
        });

        // Generate API key preview
        document.getElementById('generateKeyBtn').addEventListener('click', async function() {
            try {
                const response = await fetch('/settings/api-keys/generate');
                const data = await response.json();
                document.getElementById('generatedKeyPreview').value = data.key;
            } catch (error) {
                console.error('Error generating key:', error);
                alert('Failed to generate key preview');
            }
        });

        // Create API key
        document.getElementById('createApiKeyBtn').addEventListener('click', async function() {
            const name = document.getElementById('apiKeyName').value.trim();
            const description = document.getElementById('apiKeyDescription').value.trim();

            if (!name || name.length < 3) {
                alert('Please enter a name (minimum 3 characters)');
                return;
            }

            try {
                const formData = new FormData();
                formData.append('name', name);
                if (description) {
                    formData.append('description', description);
                }

                const response = await fetch('/settings/api-keys/create', {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();

                if (data.success) {
                    // Hide create modal
                    const createModal = bootstrap.Modal.getInstance(document.getElementById('createApiKeyModal'));
                    createModal.hide();

                    // Show created key modal with the plain text key
                    document.getElementById('createdKeyName').textContent = data.apiKey.name;
                    document.getElementById('createdKeyValue').value = data.plainTextKey;

                    const createdModal = new bootstrap.Modal(document.getElementById('apiKeyCreatedModal'));
                    createdModal.show();

                    // Reset form
                    document.getElementById('createApiKeyForm').reset();
                    document.getElementById('generatedKeyPreview').value = '';
                } else {
                    alert('Error: ' + data.error);
                }
            } catch (error) {
                console.error('Error creating API key:', error);
                alert('Failed to create API key');
            }
        });

        // Copy API key to clipboard
        document.getElementById('copyKeyBtn').addEventListener('click', function() {
            const keyInput = document.getElementById('createdKeyValue');
            keyInput.select();
            document.execCommand('copy');

            // Change button text temporarily
            const btn = this;
            const originalHTML = btn.innerHTML;
            btn.innerHTML = '<i class="bi bi-check"></i> Copied!';
            btn.classList.remove('btn-primary');
            btn.classList.add('btn-success');

            setTimeout(() => {
                btn.innerHTML = originalHTML;
                btn.classList.remove('btn-success');
                btn.classList.add('btn-primary');
            }, 2000);
        });

        // Deactivate API key - Show modal for confirmation
        let currentDeactivateId = null;

        function deactivateApiKey(id) {
            currentDeactivateId = id;
            const modal = new bootstrap.Modal(document.getElementById('deactivateApiKeyModal'));
            modal.show();
        }

        // Confirm deactivate button handler
        document.getElementById('confirmDeactivateBtn').addEventListener('click', async function() {
            if (!currentDeactivateId) return;

            try {
                const response = await fetch(`/settings/api-keys/${currentDeactivateId}/deactivate`, {
                    method: 'POST'
                });

                const data = await response.json();

                if (data.success) {
                    bootstrap.Modal.getInstance(document.getElementById('deactivateApiKeyModal')).hide();
                    location.reload();
                } else {
                    alert('Error: ' + data.error);
                }
            } catch (error) {
                console.error('Error deactivating API key:', error);
                alert('Failed to deactivate API key');
            }
        });

        // Activate API key
        async function activateApiKey(id) {
            try {
                const response = await fetch(`/settings/api-keys/${id}/activate`, {
                    method: 'POST'
                });

                const data = await response.json();

                if (data.success) {
                    location.reload();
                } else {
                    alert('Error: ' + data.error);
                }
            } catch (error) {
                console.error('Error activating API key:', error);
                alert('Failed to activate API key');
            }
        }

        // Delete API key - Show modal for confirmation
        let currentDeleteId = null;

        function deleteApiKey(id, name) {
            currentDeleteId = id;
            document.getElementById('deleteKeyNameDisplay').textContent = name;
            const modal = new bootstrap.Modal(document.getElementById('deleteApiKeyModal'));
            modal.show();
        }

        // Confirm delete button handler
        document.getElementById('confirmDeleteBtn').addEventListener('click', async function() {
            if (!currentDeleteId) return;

            try {
                const response = await fetch(`/settings/api-keys/${currentDeleteId}`, {
                    method: 'DELETE'
                });

                const data = await response.json();

                if (data.success) {
                    bootstrap.Modal.getInstance(document.getElementById('deleteApiKeyModal')).hide();
                    location.reload();
                } else {
                    alert('Error: ' + data.error);
                }
            } catch (error) {
                console.error('Error deleting API key:', error);
                alert('Failed to delete API key');
            }
        });
    </script>
</div>
</body>
</html>
